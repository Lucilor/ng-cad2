<div #cadContainer (contextmenu)="onContextMenu($event)"></div>

<div
    style="visibility: hidden; position: fixed"
    [style.left]="contextMenuPosition.x"
    [style.top]="contextMenuPosition.y"
    [matMenuTriggerFor]="contextMenu"
></div>
<mat-menu #contextMenu="matMenu">
    <ng-template matMenuContent>
        <button mat-menu-item (click)="zoomAll()">居中</button>
        <button mat-menu-item (click)="refresh()">刷新</button>
        <button mat-menu-item (click)="toggleAllMenu()">{{ showAllMenu ? "隐藏" : "显示" }}菜单</button>
    </ng-template>
</mat-menu>

<div class="menus">
    <div class="menu top" [@closeTop]="showTopMenu ? 'open' : 'closed'">
        <app-toolbar></app-toolbar>
    </div>

    <div class="menus-row">
        <div class="menu left" [style.width.px]="leftMenuWidth$ | async" [@closeLeft]="showLeftMenu ? 'open' : 'closed'">
            <div class="btn-group" style="width: 100%">
                <button mat-raised-button color="accent" (click)="save()">
                    <ngx-ui-loader [loaderId]="loaderId" [fgsSize]="30" [hasProgressBar]="false"></ngx-ui-loader>
                    保存
                </button>
                <button mat-icon-button class="menu-icon left" [class.closed]="!showLeftMenu" (click)="toggleLeftMenu()">
                    <mat-icon>
                        {{ showLeftMenu ? "navigate_before" : "navigate_next" }}
                    </mat-icon>
                </button>
            </div>
            <app-sub-cads></app-sub-cads>
            <div class="width-indicator" @menuWidth *ngIf="isDraggingLeft">{{ leftMenuWidth$ | async }}px</div>
            <div
                class="resize-handle-right"
                cdkDrag
                [cdkDragData]="dragDataLeft"
                cdkDragLockAxis="x"
                (cdkDragStarted)="onResizeMenuStart($event, 'leftMenuWidth')"
                (cdkDragMoved)="onResizeMenu($event, 'leftMenuWidth')"
                (cdkDragEnded)="onResizeMenuEnd($event, 'leftMenuWidth')"
            ></div>
        </div>

        <div class="menu right" [style.width.px]="rightMenuWidth$ | async" [@closeRight]="showRightMenu ? 'open' : 'closed'">
            <div class="btn-group" style="width: 100%">
                <button mat-icon-button class="menu-icon right" [class.closed]="!showRightMenu" (click)="toggleRightMenu()">
                    <mat-icon>
                        {{ showRightMenu ? "navigate_next" : "navigate_before" }}
                    </mat-icon>
                </button>
            </div>
            <mat-accordion multi style="width: 100%">
                <mat-expansion-panel expanded *ngIf="shownMenus.includes('entityInfo')">
                    <mat-expansion-panel-header>
                        <mat-panel-title
                            >CAD信息 <span>(总长: {{ cadLength }})</span></mat-panel-title
                        >
                    </mat-expansion-panel-header>
                    <mat-slide-toggle [checked]="multiSelect" (change)="toggleMultiSelect()">
                        实体{{ multiSelect ? "多选" : "单选" }}
                    </mat-slide-toggle>
                    <br />
                    <!-- <mat-slide-toggle [checked]="!!entityDraggable" (change)="toggleEntityDraggable()"> 实体拖动 </mat-slide-toggle> -->
                    <mat-tab-group #infoTabs dynamicHeight (selectedTabChange)="onInfoTabChange($event)">
                        <mat-tab label="CAD">
                            <perfect-scrollbar>
                                <app-cad-info (cadLengthsChange)="onCadLengthsChange($event)"></app-cad-info>
                            </perfect-scrollbar>
                        </mat-tab>
                        <mat-tab label="线段">
                            <perfect-scrollbar>
                                <app-cad-line></app-cad-line>
                            </perfect-scrollbar>
                        </mat-tab>
                        <mat-tab label="文本">
                            <perfect-scrollbar>
                                <app-cad-mtext></app-cad-mtext>
                            </perfect-scrollbar>
                        </mat-tab>
                        <mat-tab label="标注">
                            <perfect-scrollbar>
                                <app-cad-dimension></app-cad-dimension>
                            </perfect-scrollbar>
                        </mat-tab>
                    </mat-tab-group>
                </mat-expansion-panel>
                <mat-expansion-panel expanded *ngIf="shownMenus.includes('cadAssemble')">
                    <mat-expansion-panel-header>
                        <mat-panel-title>装配CAD</mat-panel-title>
                    </mat-expansion-panel-header>
                    <perfect-scrollbar style="height: calc(100vh - 180px)">
                        <app-cad-assemble></app-cad-assemble>
                    </perfect-scrollbar>
                </mat-expansion-panel>
            </mat-accordion>
            <div class="width-indicator" @menuWidth *ngIf="isDraggingRight">{{ rightMenuWidth$ | async }}px</div>
            <div
                class="resize-handle-left"
                cdkDrag
                [cdkDragData]="dragDataRight"
                cdkDragLockAxis="x"
                (cdkDragStarted)="onResizeMenuStart($event, 'rightMenuWidth')"
                (cdkDragMoved)="onResizeMenu($event, 'rightMenuWidth')"
                (cdkDragEnded)="onResizeMenuEnd($event, 'rightMenuWidth')"
            ></div>
        </div>
    </div>

    <div class="menu bottom" [class.accent]="cadStatusStr !== '普通'" [@closeBottom]="showBottomMenu ? 'open' : 'closed'">
        <div class="cad-status">当前状态：{{ cadStatusStr }}</div>
    </div>
</div>

<app-cad-console></app-cad-console>
<app-cad-points></app-cad-points>
